# ğŸ” CÆ¡ Cháº¿ Báº£o Máº­t Citizen Card Applet v3.0

---

## ğŸ“‘ Má»¥c Lá»¥c

1. [Giáº£i ThÃ­ch CÆ¡ Cháº¿ MÃ£ HÃ³a (Thuyáº¿t TrÃ¬nh)](#-giáº£i-thÃ­ch-cÆ¡-cháº¿-mÃ£-hÃ³a-dÃ nh-cho-thuyáº¿t-trÃ¬nh)
2. [Tá»•ng Quan CÃ¡c Thuáº­t ToÃ¡n MÃ£ HÃ³a](#tá»•ng-quan-cÃ¡c-thuáº­t-toÃ¡n-mÃ£-hÃ³a)
   - [PBKDF2](#-pbkdf2-password-based-key-derivation-function-2)
   - [HMAC-SHA1](#-hmac-sha1-hash-based-message-authentication-code)
   - [AES-128 ECB](#-aes-128-ecb-advanced-encryption-standard)
   - [RSA-1024 Digital Signature](#ï¸-rsa-1024-digital-signature)
3. [Pháº§n 1: MÃ´ Táº£ Luá»“ng Hoáº¡t Äá»™ng](#pháº§n-1-mÃ´-táº£-báº±ng-lá»i)
4. [Pháº§n 2: Kiáº¿n TrÃºc vÃ  Code](#pháº§n-2-kiáº¿n-trÃºc-vÃ -code)

---

## ğŸ”‘ TÃ³m Táº¯t Kiáº¿n TrÃºc KhÃ³a

**1. PIN Key (KhÃ³a báº£o vá»‡):**
- ÄÆ°á»£c sinh ra tá»« mÃ£ PIN cá»§a cÆ° dÃ¢n thÃ´ng qua hÃ m PBKDF2-HMAC-SHA1
- Sá»­ dá»¥ng Ä‘á»ƒ mÃ£ hÃ³a (wrap) Master Key
- Má»¥c Ä‘Ã­ch: Chá»‰ Ä‘á»ƒ báº£o vá»‡ Master Key khi lÆ°u trá»¯ trÃªn tháº»

**2. Master Key (KhÃ³a dá»¯ liá»‡u):**
- LÃ  má»™t khÃ³a AES-128 ngáº«u nhiÃªn, Ä‘Æ°á»£c sinh ra duy nháº¥t má»™t láº§n khi khá»Ÿi táº¡o tháº»
- ÄÆ°á»£c lÆ°u trÃªn tháº» dÆ°á»›i dáº¡ng **Ä‘Ã£ mÃ£ hÃ³a** bá»Ÿi PIN Key
- Khi sá»­ dá»¥ng (sau khi Verify PIN xong), Master Key Ä‘Æ°á»£c giáº£i mÃ£ vÃ  náº¡p vÃ o RAM
- Sá»­ dá»¥ng trá»±c tiáº¿p: Master Key nÃ y dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a/giáº£i mÃ£ cÃ¡c trÆ°á»ng nhÆ° `Balance`, `Info`, `Avatar`...

**3. RSA Key Pair (KhÃ³a xÃ¡c thá»±c):**
- Private Key lÆ°u trÃªn tháº», khÃ´ng bao giá» export
- Public Key gá»­i vá» database khi Ä‘Äƒng kÃ½
- DÃ¹ng cho chá»¯ kÃ½ sá»‘ xÃ¡c thá»±c tháº» khÃ´ng bá»‹ giáº£ máº¡o

**SÆ¡ Ä‘á»“ tÃ³m táº¯t:**

> `MÃ£ PIN` â†’ *(sinh ra)* â†’ `PIN Key` â†’ *(mÃ£ hÃ³a/giáº£i mÃ£)* â†’ `Master Key` â†’ *(mÃ£ hÃ³a/giáº£i mÃ£)* â†’ `Dá»¯ liá»‡u tháº»`

---

## ğŸ¤ Giáº£i ThÃ­ch CÆ¡ Cháº¿ MÃ£ HÃ³a (DÃ nh Cho Thuyáº¿t TrÃ¬nh)

Há»‡ thá»‘ng sá»­ dá»¥ng **3 cÆ¡ cháº¿ mÃ£ hÃ³a chÃ­nh**: PBKDF2-HMAC-SHA1 Ä‘á»ƒ sinh khÃ³a tá»« PIN, AES-128 Ä‘á»ƒ mÃ£ hÃ³a dá»¯ liá»‡u, vÃ  RSA-1024 Ä‘á»ƒ táº¡o chá»¯ kÃ½ sá»‘ xÃ¡c thá»±c tháº».

**QuÃ¡ trÃ¬nh mÃ£ hÃ³a dá»¯ liá»‡u** sá»­ dá»¥ng kiáº¿n trÃºc hai lá»›p khÃ³a gá»“m PIN Key vÃ  Master Key. PIN Key lÃ  khÃ³a 16 bytes Ä‘Æ°á»£c sinh tá»« PIN cá»§a cÆ° dÃ¢n thÃ´ng qua thuáº­t toÃ¡n PBKDF2-HMAC-SHA1 vá»›i 1000 vÃ²ng láº·p, sá»­ dá»¥ng Card ID lÃ m salt Ä‘á»ƒ Ä‘áº£m báº£o má»—i tháº» cÃ³ khÃ³a riÃªng biá»‡t dÃ¹ cÃ¹ng PIN. Master Key lÃ  khÃ³a ngáº«u nhiÃªn 16 bytes Ä‘Æ°á»£c sinh bá»Ÿi bá»™ sinh sá»‘ ngáº«u nhiÃªn báº£o máº­t RandomData.ALG_SECURE_RANDOM trÃªn tháº». PIN Key chá»‰ dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a Master Key, cÃ²n Master Key dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a toÃ n bá»™ dá»¯ liá»‡u thá»±c táº¿ bao gá»“m encryptedBalance, encryptedInfo vÃ  avatar.

**QuÃ¡ trÃ¬nh khá»Ÿi táº¡o tháº»**: Applet nháº­n PIN vÃ  Card ID tá»« admin, gá»i hÃ m derivePinKey() Ä‘á»ƒ sinh PIN Key báº±ng PBKDF2(PIN, CardID, 1000 iterations), gá»i randomData.generateData() Ä‘á»ƒ sinh Master Key ngáº«u nhiÃªn, sau Ä‘Ã³ mÃ£ hÃ³a Master Key báº±ng AES vá»›i PIN Key vÃ  lÆ°u vÃ o encryptedMasterKey. Sá»‘ dÆ° Ä‘Æ°á»£c khá»Ÿi táº¡o báº±ng 0, mÃ£ hÃ³a báº±ng Master Key vÃ  lÆ°u vÃ o encryptedBalance.

**QuÃ¡ trÃ¬nh xÃ¡c thá»±c PIN**: Applet nháº­n PIN qua lá»‡nh APDU VERIFY_PIN, gá»i derivePinKey() Ä‘á»ƒ sinh tempPinKey, so sÃ¡nh vá»›i PIN Key Ä‘Ã£ lÆ°u báº±ng Util.arrayCompare(). Náº¿u khá»›p thÃ¬ giáº£i mÃ£ encryptedMasterKey báº±ng AES vá»›i tempPinKey Ä‘á»ƒ láº¥y Master Key, Ä‘áº·t pinVerified = true vÃ  reset pinTryCounter = 5. Náº¿u sai thÃ¬ giáº£m pinTryCounter, khi vá» 0 tháº» khÃ³a vÄ©nh viá»…n.

**QuÃ¡ trÃ¬nh Ä‘á»c/ghi dá»¯ liá»‡u**: Applet kiá»ƒm tra pinVerified, náº¿u true thÃ¬ khá»Ÿi táº¡o AES cipher vá»›i Master Key vÃ  gá»i aesCipher.doFinal() Ä‘á»ƒ giáº£i mÃ£ encryptedBalance/encryptedInfo/avatar rá»“i tráº£ vá», hoáº·c mÃ£ hÃ³a dá»¯ liá»‡u má»›i rá»“i lÆ°u vÃ o bá»™ nhá»› tháº».

**QuÃ¡ trÃ¬nh Ä‘á»•i PIN**: Applet xÃ¡c thá»±c PIN cÅ©, giáº£i mÃ£ encryptedMasterKey báº±ng PIN Key cÅ© Ä‘á»ƒ láº¥y Master Key plaintext, sinh PIN Key má»›i tá»« PIN má»›i báº±ng derivePinKey(), mÃ£ hÃ³a láº¡i Master Key báº±ng PIN Key má»›i vÃ  lÆ°u vÃ o encryptedMasterKey. Dá»¯ liá»‡u khÃ´ng cáº§n mÃ£ hÃ³a láº¡i vÃ¬ Master Key khÃ´ng Ä‘á»•i.

**Chá»¯ kÃ½ sá»‘ RSA-1024**: Má»—i tháº» cÃ³ má»™t cáº·p khÃ³a RSA-1024 riÃªng Ä‘Æ°á»£c sinh khi khá»Ÿi táº¡o. Private Key Ä‘Æ°á»£c lÆ°u trÃªn tháº» vÃ  khÃ´ng bao giá» export ra ngoÃ i. Public Key Ä‘Æ°á»£c gá»­i vá» database khi Ä‘Äƒng kÃ½ tháº». Khi cáº§n xÃ¡c thá»±c tháº», server gá»­i má»™t challenge ngáº«u nhiÃªn, applet kÃ½ challenge báº±ng rsaCipher.doFinal() vá»›i Private Key vÃ  tráº£ vá» signature. Server verify signature báº±ng Public Key Ä‘á»ƒ xÃ¡c nháº­n Ä‘Ã¢y lÃ  tháº» há»£p lá»‡ chá»© khÃ´ng pháº£i tháº» giáº£ máº¡o. Chá»©c nÄƒng nÃ y Ä‘Æ°á»£c triá»ƒn khai qua lá»‡nh APDU CREATE_SIGNATURE (INS=0x01, P1=0x06).

**Kháº£ nÄƒng chá»‘ng táº¥n cÃ´ng**: Dá»¯ liá»‡u trÃªn tháº» Ä‘á»u mÃ£ hÃ³a AES-128 nÃªn khÃ´ng Ä‘á»c Ä‘Æ°á»£c náº¿u khÃ´ng cÃ³ Master Key. Káº» táº¥n cÃ´ng khÃ´ng cÃ³ PIN nÃªn khÃ´ng sinh Ä‘Æ°á»£c PIN Key Ä‘á»ƒ giáº£i mÃ£ Master Key. Tháº» giá»›i háº¡n 5 láº§n thá»­ PIN, má»—i láº§n pháº£i tÃ­nh PBKDF2 vá»›i 1000 vÃ²ng nÃªn máº¥t 100ms, sau 5 láº§n sai tháº» khÃ³a vÄ©nh viá»…n vá»›i xÃ¡c suáº¥t Ä‘oÃ¡n Ä‘Ãºng 0,05%. PBKDF2 sá»­ dá»¥ng Card ID lÃ m salt nÃªn cÃ¹ng PIN váº«n cho PIN Key khÃ¡c nhau giá»¯a cÃ¡c tháº». RSA Ä‘áº£m báº£o khÃ´ng thá»ƒ giáº£ máº¡o tháº» vÃ¬ Private Key khÃ´ng bao giá» rá»i khá»i chip báº£o máº­t.

---


## Tá»•ng Quan CÃ¡c Thuáº­t ToÃ¡n MÃ£ HÃ³a

### ğŸ”‘ PBKDF2 (Password-Based Key Derivation Function 2)

**PBKDF2** lÃ  thuáº­t toÃ¡n sinh khÃ³a tá»« máº­t kháº©u, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ chá»‘ng láº¡i cÃ¡c cuá»™c táº¥n cÃ´ng brute-force vÃ  dictionary attack.

#### NguyÃªn lÃ½ hoáº¡t Ä‘á»™ng:

```
PBKDF2(Password, Salt, Iterations, KeyLength) â†’ DerivedKey
```

| ThÃ nh pháº§n | MÃ´ táº£ | GiÃ¡ trá»‹ trong Applet |
|------------|-------|---------------------|
| **Password** | Máº­t kháº©u gá»‘c cáº§n báº£o vá»‡ | PIN (4 bytes) |
| **Salt** | GiÃ¡ trá»‹ ngáº«u nhiÃªn, unique per user | Card ID (UUID) |
| **Iterations** | Sá»‘ vÃ²ng láº·p hash | 1000 |
| **KeyLength** | Äá»™ dÃ i khÃ³a Ä‘áº§u ra | 16 bytes (128-bit) |

#### CÃ´ng thá»©c toÃ¡n há»c:

```
DK = T1 || T2 || ... || Tdklen/hlen

Trong Ä‘Ã³:
  Ti = F(Password, Salt, c, i)
  F(Password, Salt, c, i) = U1 XOR U2 XOR ... XOR Uc
  
  U1 = PRF(Password, Salt || INT(i))     // PRF = HMAC-SHA1
  U2 = PRF(Password, U1)
  ...
  Uc = PRF(Password, Uc-1)
```

#### SÆ¡ Ä‘á»“ minh há»a:

```
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                        PBKDF2                                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                               â”‚                               â”‚
      â–¼                               â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Salt    â”‚                   â”‚    PIN    â”‚                   â”‚   1000    â”‚
â”‚ (CardID)  â”‚                   â”‚ (4 bytes) â”‚                   â”‚iterations â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                               â”‚                               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
                      â”‚                                               â”‚
                      â–¼                                               â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
           â”‚  Salt || INT(1)  â”‚                                       â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
                    â”‚                                                 â”‚
                    â–¼                                                 â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
     â”Œâ”€â”€â”€â”€â–¶â”‚   HMAC-SHA1      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ PIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚ â”‚
     â”‚              â”‚                                               â”‚ â”‚
     â”‚              â–¼                                               â”‚ â”‚
     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚ â”‚
     â”‚     â”‚       U1         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚ â”‚
     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                      â”‚ â”‚
     â”‚              â”‚                        â”‚                      â”‚ â”‚
     â”‚              â–¼                        â”‚                      â”‚ â”‚
     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                      â”‚ â”‚
     â””â”€â”€â”€â”€â–¶â”‚   HMAC-SHA1      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                        â”‚
                    â”‚                        â”‚                        â”‚
                    â–¼                        â–¼                        â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
           â”‚       U2         â”‚     â”‚   U1 XOR U2      â”‚ â—€â”€â”€ Láº·p 1000 láº§n
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
                   ...                       â”‚
                    â”‚                        â–¼
                    â–¼               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    PIN Key       â”‚
           â”‚      U1000       â”‚â”€â”€â”€â”€â–¶â”‚   (16 bytes)     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Táº¡i sao PBKDF2 an toÃ n?

1. **Salt ngÄƒn Rainbow Table Attack**: Má»—i tháº» cÃ³ Card ID khÃ¡c nhau â†’ cÃ¹ng PIN "1234" sáº½ sinh ra PIN Key khÃ¡c nhau
2. **Iterations lÃ m cháº­m Brute-force**: 1000 vÃ²ng láº·p = thá»i gian thá»­ má»—i PIN tÄƒng 1000 láº§n
3. **On-card execution**: PIN khÃ´ng bao giá» rá»i khá»i tháº»

---

### ğŸ” HMAC-SHA1 (Hash-based Message Authentication Code)

**HMAC** lÃ  thuáº­t toÃ¡n xÃ¡c thá»±c thÃ´ng Ä‘iá»‡p dá»±a trÃªn hash, káº¿t há»£p má»™t khÃ³a bÃ­ máº­t vá»›i hÃ m hash.

#### CÃ´ng thá»©c:

```
HMAC(K, m) = H((K' âŠ• opad) || H((K' âŠ• ipad) || m))

Trong Ä‘Ã³:
  K' = K Ä‘Æ°á»£c padding Ä‘áº¿n 64 bytes (block size cá»§a SHA-1)
  ipad = 0x36 láº·p láº¡i 64 láº§n (inner padding)
  opad = 0x5C láº·p láº¡i 64 láº§n (outer padding)
  H = SHA-1 hash function
  âŠ• = XOR operation
  || = concatenation
```

#### SÆ¡ Ä‘á»“ minh há»a:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              HMAC-SHA1                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    Key    â”‚                              â”‚  Message  â”‚
     â”‚  (PIN)    â”‚                              â”‚(Salt||INT)â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚                                          â”‚
           â–¼                                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
     â”‚  Pad to 64 bytes  â”‚                            â”‚
     â”‚       (K')        â”‚                            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
               â”‚                                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
       â”‚               â”‚                              â”‚
       â–¼               â–¼                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
  â”‚K' âŠ• ipadâ”‚     â”‚K' âŠ• opadâ”‚                         â”‚
  â”‚ (0x36)  â”‚     â”‚ (0x5C)  â”‚                         â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
       â”‚               â”‚                              â”‚
       â–¼               â”‚                              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  (K' âŠ• ipad) || Message         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Message  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   SHA-1    â”‚  â—„â”€â”€ Inner Hash
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚Inner Hash  â”‚
         â”‚ (20 bytes) â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  (K' âŠ• opad) || Inner Hash      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   SHA-1    â”‚  â—„â”€â”€ Outer Hash
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   HMAC     â”‚
         â”‚ (20 bytes) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Äáº·c Ä‘iá»ƒm SHA-1:

| Thuá»™c tÃ­nh | GiÃ¡ trá»‹ |
|------------|---------|
| Output size | 160 bits (20 bytes) |
| Block size | 512 bits (64 bytes) |
| Rounds | 80 |
| Operations | AND, OR, XOR, ROT |

---

### ğŸ”’ AES-128 ECB (Advanced Encryption Standard)

**AES** lÃ  thuáº­t toÃ¡n mÃ£ hÃ³a Ä‘á»‘i xá»©ng tiÃªu chuáº©n, Ä‘Æ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i nháº¥t hiá»‡n nay.

#### ThÃ´ng sá»‘ ká»¹ thuáº­t:

| Thuá»™c tÃ­nh | GiÃ¡ trá»‹ |
|------------|---------|
| Key size | 128 bits (16 bytes) |
| Block size | 128 bits (16 bytes) |
| Rounds | 10 |
| Mode | ECB (Electronic Codebook) |

#### Cáº¥u trÃºc má»™t vÃ²ng AES:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AES Round Structure                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Input Block    â”‚   16 bytes (128 bits)
    â”‚   (Plaintext)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    SubBytes      â”‚   Thay tháº¿ tá»«ng byte qua S-Box
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ShiftRows      â”‚   Dá»‹ch vÃ²ng cÃ¡c hÃ ng
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   MixColumns     â”‚   Trá»™n cÃ¡c cá»™t (bá» á»Ÿ vÃ²ng cuá»‘i)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   AddRoundKey    â”‚â—€â”€â”€â”€â”€â”‚  Round Key   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Output Block   â”‚   16 bytes (128 bits)
    â”‚   (Ciphertext)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             
                Ã— 10 vÃ²ng
```

#### ECB Mode (Electronic Codebook):

```
Plaintext:   â”‚ Block 1  â”‚ Block 2  â”‚ Block 3  â”‚ Block 4  â”‚
             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                  â”‚          â”‚          â”‚          â”‚
                  â–¼          â–¼          â–¼          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
     Key â”€â”€â”€â–¶â”‚AES Enc â”‚ â”‚AES Enc â”‚ â”‚AES Enc â”‚ â”‚AES Enc â”‚â—€â”€â”€â”€ Key
             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                  â”‚          â”‚          â”‚          â”‚
                  â–¼          â–¼          â–¼          â–¼
Ciphertext:  â”‚ Block 1' â”‚ Block 2' â”‚ Block 3' â”‚ Block 4' â”‚
```

> **LÆ°u Ã½**: ECB mode Ä‘Æ¡n giáº£n nhÆ°ng khÃ´ng che giáº¥u pattern trong dá»¯ liá»‡u. Trong applet, Ä‘iá»u nÃ y cháº¥p nháº­n Ä‘Æ°á»£c vÃ¬ má»—i block dá»¯ liá»‡u (balance, info) thÆ°á»ng nhá» vÃ  unique.

---

### ğŸ–Šï¸ RSA-1024 Digital Signature

**RSA** lÃ  thuáº­t toÃ¡n mÃ£ hÃ³a báº¥t Ä‘á»‘i xá»©ng, sá»­ dá»¥ng cáº·p khÃ³a public/private.

#### ThÃ´ng sá»‘ ká»¹ thuáº­t:

| Thuá»™c tÃ­nh | GiÃ¡ trá»‹ |
|------------|---------|
| Key size | 1024 bits |
| Modulus (n) | 1024 bits |
| Public exponent (e) | ThÆ°á»ng lÃ  65537 (0x10001) |
| Signature scheme | RSASSA-PKCS1-v1_5 |
| Hash function | SHA-1 |

#### ToÃ¡n há»c RSA:

```
Sinh khÃ³a:
  1. Chá»n 2 sá»‘ nguyÃªn tá»‘ lá»›n: p, q
  2. n = p Ã— q                    (modulus, 1024 bits)
  3. Ï†(n) = (p-1) Ã— (q-1)         (Euler's totient)
  4. Chá»n e sao cho gcd(e, Ï†(n)) = 1
  5. d = eâ»Â¹ mod Ï†(n)            (private exponent)

Public Key:  (n, e)
Private Key: (n, d)

KÃ½ sá»‘:
  signature = message^d mod n

XÃ¡c thá»±c:
  message' = signature^e mod n
  Verify: message' == message ?
```

#### SÆ¡ Ä‘á»“ kÃ½ sá»‘:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RSA Digital Signature                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Táº O CHá»® KÃ (TrÃªn tháº»)                  XÃC THá»°C (TrÃªn Desktop)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Challenge   â”‚                      â”‚   Signature   â”‚
  â”‚  (tá»« Server)  â”‚                      â”‚  (tá»« Tháº»)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                      â”‚
          â–¼                                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    SHA-1      â”‚                      â”‚  signature^e  â”‚
  â”‚    Hash       â”‚                      â”‚    mod n      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                      â”‚
          â–¼                                      â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
  â”‚ PKCS#1 v1.5   â”‚                              â”‚
  â”‚   Padding     â”‚                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
          â”‚                                      â”‚
          â–¼                                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     So sÃ¡nh         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   padded^d    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Recovered   â”‚
  â”‚    mod n      â”‚                     â”‚   Message     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Signature   â”‚
  â”‚  (128 bytes)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ“Š So SÃ¡nh CÃ¡c Thuáº­t ToÃ¡n

| Thuáº­t toÃ¡n | Loáº¡i | Input | Output | Má»¥c Ä‘Ã­ch |
|------------|------|-------|--------|----------|
| **PBKDF2** | Key Derivation | Password + Salt | Key (16B) | Sinh khÃ³a tá»« PIN |
| **HMAC-SHA1** | MAC | Key + Message | Hash (20B) | XÃ¡c thá»±c trong PBKDF2 |
| **SHA-1** | Hash | Any data | Hash (20B) | Hash 1 chiá»u |
| **AES-128** | Symmetric | Key + Plaintext | Ciphertext | MÃ£ hÃ³a dá»¯ liá»‡u |
| **RSA-1024** | Asymmetric | Private/Public Key | Signature | KÃ½ sá»‘, xÃ¡c thá»±c |

---

### ğŸ”— CÃ¡ch CÃ¡c Thuáº­t ToÃ¡n Káº¿t Há»£p

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SECURITY ALGORITHM CHAIN                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    USER INPUT                    KEY DERIVATION                DATA PROTECTION
    â•â•â•â•â•â•â•â•â•â•â•                   â•â•â•â•â•â•â•â•â•â•â•â•â•â•                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   PIN    â”‚
  â”‚ (4 digits)â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â–¶â”‚              PBKDF2                     â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
            â”‚  â”‚         HMAC-SHA1               â”‚    â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
            â”‚  â”‚  â”‚        SHA-1          â”‚      â”‚    â”‚ Ã— 1000
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PIN Key    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   AES-128    â”‚
                    â”‚  (16 bytes)  â”‚         â”‚   Decrypt    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  Master Key  â”‚
                                             â”‚  (16 bytes)  â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚                        â”‚                        â”‚
                           â–¼                        â–¼                        â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   AES-128    â”‚         â”‚   AES-128    â”‚         â”‚   AES-128    â”‚
                    â”‚   Encrypt    â”‚         â”‚   Encrypt    â”‚         â”‚   Encrypt    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                        â”‚                        â”‚
                           â–¼                        â–¼                        â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Balance    â”‚         â”‚    Info      â”‚         â”‚   Avatar     â”‚
                    â”‚  (encrypted) â”‚         â”‚ (encrypted)  â”‚         â”‚ (encrypted)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    IDENTITY VERIFICATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Challenge   â”‚
  â”‚  (random)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   RSA-1024   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Private Key  â”‚  (stored on card)
  â”‚     Sign     â”‚         â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Signature   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Verify with â”‚â—€â”€â”€ Public Key (in DB)
  â”‚ (128 bytes)  â”‚         â”‚  Public Key  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Pháº§n 1: MÃ´ Táº£ Báº±ng Lá»i

### 1.1 Tá»•ng Quan Kiáº¿n TrÃºc Báº£o Máº­t

Citizen Card Applet v3.0 sá»­ dá»¥ng kiáº¿n trÃºc **hai lá»›p khÃ³a** (Two-Layer Key Architecture) Ä‘á»ƒ báº£o vá»‡ dá»¯ liá»‡u:

1. **PIN Key** - KhÃ³a Ä‘Æ°á»£c sinh tá»« PIN cá»§a ngÆ°á»i dÃ¹ng thÃ´ng qua thuáº­t toÃ¡n PBKDF2-HMAC-SHA1
2. **Master Key** - KhÃ³a ngáº«u nhiÃªn 128-bit, Ä‘Æ°á»£c mÃ£ hÃ³a bá»Ÿi PIN Key vÃ  dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a toÃ n bá»™ dá»¯ liá»‡u

#### Táº¡i sao cáº§n hai lá»›p khÃ³a?

**Váº¥n Ä‘á» vá»›i kiáº¿n trÃºc cÅ© (v1.0-v2.0):**
- PIN trá»±c tiáº¿p sinh ra khÃ³a AES (qua MD5 hash)
- Khi Ä‘á»•i PIN â†’ pháº£i giáº£i mÃ£ vÃ  mÃ£ hÃ³a láº¡i TOÃ€N Bá»˜ dá»¯ liá»‡u (Balance, Info, Avatar = ~16KB)
- Tá»‘n thá»i gian, tá»‘n bá»™ nhá»›, cÃ³ nguy cÆ¡ máº¥t dá»¯ liá»‡u náº¿u quÃ¡ trÃ¬nh bá»‹ giÃ¡n Ä‘oáº¡n

**Giáº£i phÃ¡p v3.0:**
- PIN â†’ PBKDF2 â†’ **PIN Key** (chá»‰ dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a Master Key)
- **Master Key** (ngáº«u nhiÃªn) â†’ mÃ£ hÃ³a dá»¯ liá»‡u thá»±c táº¿
- Khi Ä‘á»•i PIN â†’ chá»‰ cáº§n re-encrypt Master Key (16 bytes) â†’ nhanh vÃ  an toÃ n

---

### 1.2 Luá»“ng Khá»Ÿi Táº¡o Tháº» (Card Initialization)

Khi Admin táº¡o tháº» má»›i cho cÆ° dÃ¢n:

1. **Nháº­n dá»¯ liá»‡u**: Desktop gá»­i PIN (4 sá»‘) vÃ  Card ID (UUID) lÃªn tháº»
2. **Sinh PIN Key**: 
   - Applet thá»±c hiá»‡n PBKDF2-HMAC-SHA1 vá»›i:
     - Password = PIN (4 bytes)
     - Salt = Card ID (Ä‘áº£m báº£o má»—i tháº» cÃ³ key khÃ¡c nhau dÃ¹ cÃ¹ng PIN)
     - Iterations = 1000 vÃ²ng láº·p
   - Káº¿t quáº£: PIN Key 16 bytes
3. **Sinh Master Key**: Applet sinh ngáº«u nhiÃªn 16 bytes báº±ng `RandomData.ALG_SECURE_RANDOM`
4. **MÃ£ hÃ³a Master Key**: DÃ¹ng PIN Key Ä‘á»ƒ mÃ£ hÃ³a Master Key â†’ lÆ°u vÃ o `encryptedMasterKey`
5. **Khá»Ÿi táº¡o sá»‘ dÆ°**: Balance = 0, mÃ£ hÃ³a báº±ng Master Key â†’ lÆ°u vÃ o `encryptedBalance`
6. **Sinh RSA Key Pair**: Táº¡o cáº·p khÃ³a RSA-1024 cho chá»¯ kÃ½ sá»‘

**Káº¿t quáº£**: Tháº» Ä‘Ã£ sáºµn sÃ ng sá»­ dá»¥ng vá»›i toÃ n bá»™ báº£o máº­t Ä‘Æ°á»£c thiáº¿t láº­p.

---

### 1.3 Luá»“ng XÃ¡c Thá»±c PIN (PIN Verification)

Khi cÆ° dÃ¢n Ä‘Äƒng nháº­p:

1. **Nháº­n PIN**: Desktop gá»­i PIN (4 sá»‘) dáº¡ng plaintext lÃªn tháº»
2. **Kiá»ƒm tra tráº¡ng thÃ¡i**:
   - Tháº» Ä‘Ã£ khá»Ÿi táº¡o chÆ°a? (`cardInitialized`)
   - Tháº» cÃ³ bá»‹ khÃ³a khÃ´ng? (`cardActive`)
   - CÃ²n láº§n thá»­ khÃ´ng? (`pinTryCounter > 0`)
3. **Sinh PIN Key tá»« PIN nháº­n Ä‘Æ°á»£c**: PBKDF2(PIN, cardId) â†’ `tempPinKey`
4. **So sÃ¡nh vá»›i PIN Key Ä‘Ã£ lÆ°u**: 
   - Náº¿u khá»›p â†’ PIN Ä‘Ãºng
   - Náº¿u khÃ´ng khá»›p â†’ PIN sai, giáº£m `pinTryCounter`
5. **Náº¿u PIN Ä‘Ãºng**:
   - Reset `pinTryCounter = 5`
   - Giáº£i mÃ£ Master Key: AES_Decrypt(encryptedMasterKey, PIN Key) â†’ Master Key
   - ÄÃ¡nh dáº¥u `pinVerified = true`
   - Tá»« giá» má»i thao tÃ¡c Ä‘á»c/ghi dá»¯ liá»‡u Ä‘á»u dÃ¹ng Master Key

**Báº£o vá»‡ Brute-force**:
- Tá»‘i Ä‘a 5 láº§n thá»­ sai â†’ tháº» bá»‹ khÃ³a vÄ©nh viá»…n
- PBKDF2 vá»›i 1000 iterations lÃ m cháº­m quÃ¡ trÃ¬nh thá»­

---

### 1.4 Luá»“ng Äá»•i PIN (PIN Change)

Khi cÆ° dÃ¢n Ä‘á»•i máº­t kháº©u:

1. **Nháº­n dá»¯ liá»‡u**: Desktop gá»­i OLD_PIN vÃ  NEW_PIN (má»—i cÃ¡i 4 bytes)
2. **XÃ¡c thá»±c PIN cÅ©**: PBKDF2(OLD_PIN) â†’ so sÃ¡nh vá»›i PIN Key Ä‘Ã£ lÆ°u
3. **Giáº£i mÃ£ Master Key**: AES_Decrypt(encryptedMasterKey, OLD_PIN_Key) â†’ Master Key (plaintext)
4. **Sinh PIN Key má»›i**: PBKDF2(NEW_PIN, cardId) â†’ New PIN Key
5. **MÃ£ hÃ³a láº¡i Master Key**: AES_Encrypt(Master Key, New PIN Key) â†’ encryptedMasterKey

**Äiá»ƒm máº¥u chá»‘t**: 
- Master Key **KHÃ”NG Äá»”I** â†’ Balance, Info, Avatar váº«n Ä‘á»c Ä‘Æ°á»£c bÃ¬nh thÆ°á»ng
- Chá»‰ thay Ä‘á»•i lá»›p báº£o vá»‡ bÃªn ngoÃ i (PIN Key)
- QuÃ¡ trÃ¬nh chá»‰ tá»‘n ~10ms thay vÃ¬ hÃ ng giÃ¢y nhÆ° v2.0

---

### 1.5 Luá»“ng Äá»c/Ghi Dá»¯ Liá»‡u MÃ£ HÃ³a

#### Äá»c sá»‘ dÆ° (getBalance):
```
1. Kiá»ƒm tra pinVerified == true
2. AES_Decrypt(encryptedBalance, Master Key) â†’ balance (4 bytes)
3. Tráº£ vá» balance
```

#### Ghi sá»‘ dÆ° (updateBalance):
```
1. Kiá»ƒm tra pinVerified == true
2. Decrypt current balance
3. TÃ­nh toÃ¡n new balance (náº¡p tiá»n hoáº·c thanh toÃ¡n)
4. AES_Encrypt(newBalance, Master Key) â†’ encryptedBalance
5. Tráº£ vá» newBalance
```

#### Äá»c/Ghi thÃ´ng tin cÃ¡ nhÃ¢n vÃ  Avatar: TÆ°Æ¡ng tá»± vá»›i AES-128 ECB.

---

### 1.6 CÆ¡ Cháº¿ Chá»¯ KÃ½ Sá»‘ RSA

Má»—i tháº» cÃ³ má»™t cáº·p khÃ³a RSA-1024 riÃªng:
- **Private Key**: ÄÆ°á»£c sinh vÃ  lÆ°u trÃªn tháº», **KHÃ”NG BAO GIá»œ** export ra ngoÃ i
- **Public Key**: ÄÆ°á»£c gá»­i vá» database khi Ä‘Äƒng kÃ½ tháº»

**Challenge-Response Authentication**:
1. Server gá»­i má»™t `challenge` ngáº«u nhiÃªn lÃªn tháº»
2. Tháº» kÃ½ `challenge` báº±ng Private Key â†’ `signature`
3. Server verify `signature` báº±ng Public Key
4. Náº¿u verify thÃ nh cÃ´ng â†’ xÃ¡c nháº­n Ä‘Ã¢y lÃ  tháº» há»£p lá»‡

---

## Pháº§n 2: Kiáº¿n TrÃºc vÃ  Code

### 2.1 SÆ¡ Äá»“ Kiáº¿n TrÃºc Tá»•ng Thá»ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CITIZEN CARD APPLET v3.0                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• KEY MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘                                                                 â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘   â”‚
â”‚  â•‘  â”‚   User PIN   â”‚â”€â”€â”€â–¶â”‚   PBKDF2-SHA1  â”‚â”€â”€â”€â–¶â”‚   PIN Key    â”‚   â•‘   â”‚
â”‚  â•‘  â”‚  (4 digits)  â”‚    â”‚  1000 iters    â”‚    â”‚  (16 bytes)  â”‚   â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  salt=cardId   â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘   â”‚
â”‚  â•‘                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚           â•‘   â”‚
â”‚  â•‘                                                     â”‚           â•‘   â”‚
â”‚  â•‘                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â–¼           â•‘   â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   AES-128      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘   â”‚
â”‚  â•‘  â”‚ Master Key   â”‚â—€â”€â”€â”€â”‚   Decrypt      â”‚â—€â”€â”€â”€â”‚encryptedMK   â”‚   â•‘   â”‚
â”‚  â•‘  â”‚ (Random 16B) â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  (16 bytes)  â”‚   â•‘   â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘   â”‚
â”‚  â•‘         â”‚                                                       â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚            â”‚                                                           â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â• DATA ENCRYPTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—     â”‚
â”‚  â•‘         â”‚                                                     â•‘     â”‚
â”‚  â•‘         â–¼                                                     â•‘     â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â•‘     â”‚
â”‚  â•‘  â”‚  AES-128     â”‚                                             â•‘     â”‚
â”‚  â•‘  â”‚   Cipher     â”‚                                             â•‘     â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                             â•‘     â”‚
â”‚  â•‘         â”‚                                                     â•‘     â”‚
â”‚  â•‘    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â•‘     â”‚
â”‚  â•‘    â–¼         â–¼             â–¼             â–¼                   â•‘     â”‚
â”‚  â•‘ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•‘     â”‚
â”‚  â•‘ â”‚Bal-  â”‚ â”‚Info  â”‚   â”‚  Avatar   â”‚  â”‚ Master Keyâ”‚            â•‘     â”‚
â”‚  â•‘ â”‚ance  â”‚ â”‚(512B)â”‚   â”‚  (15KB)   â”‚  â”‚(encrypted)â”‚            â•‘     â”‚
â”‚  â•‘ â”‚(16B) â”‚ â”‚      â”‚   â”‚           â”‚  â”‚           â”‚            â•‘     â”‚
â”‚  â•‘ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â•‘     â”‚
â”‚  â•‘                                                               â•‘     â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚
â”‚                                                                         â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• IDENTITY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—     â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘     â”‚
â”‚  â•‘  â”‚   RSA-1024   â”‚  â”‚   Card ID    â”‚  â”‚   PIN Counter    â”‚    â•‘     â”‚
â”‚  â•‘  â”‚   Key Pair   â”‚  â”‚   (UUID)     â”‚  â”‚   (Max: 5)       â”‚    â•‘     â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘     â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 Code: Cáº¥u HÃ¬nh PBKDF2

```java
// PBKDF2 Configuration
private static final short PBKDF2_ITERATIONS = 1000; // Tá»‘i Æ°u cho JavaCard
private static final short PBKDF2_KEY_LENGTH = 16;   // 128-bit AES key
private static final short SHA1_BLOCK_SIZE = 64;
private static final short SHA1_HASH_SIZE = 20;

// Working buffers
private byte[] hmacKey;      // 64 bytes - HMAC key buffer
private byte[] hmacBuffer;   // 84 bytes - HMAC intermediate
private byte[] pbkdf2Buffer; // 20 bytes - PBKDF2 output
```

---

### 2.3 Code: Khá»Ÿi Táº¡o Crypto Components

```java
// Constructor - Khá»Ÿi táº¡o cÃ¡c thÃ nh pháº§n mÃ£ hÃ³a
protected citizen_applet() {
    // PBKDF2 working buffers
    hmacKey = new byte[SHA1_BLOCK_SIZE];                        // 64 bytes
    hmacBuffer = new byte[(short)(SHA1_BLOCK_SIZE + SHA1_HASH_SIZE)]; // 84 bytes
    pbkdf2Buffer = new byte[SHA1_HASH_SIZE];                    // 20 bytes
    
    // Crypto initialization - New Master Key Architecture
    md5 = MessageDigest.getInstance(MessageDigest.ALG_MD5, false);
    sha1 = MessageDigest.getInstance(MessageDigest.ALG_SHA, false);  // For PBKDF2
    
    // Two separate AES keys
    pinKey = (AESKey) KeyBuilder.buildKey(KeyBuilder.TYPE_AES, 
                                          KeyBuilder.LENGTH_AES_128, false);
    masterKey = (AESKey) KeyBuilder.buildKey(KeyBuilder.TYPE_AES, 
                                              KeyBuilder.LENGTH_AES_128, false);
    
    aesCipher = Cipher.getInstance(Cipher.ALG_AES_BLOCK_128_ECB_NOPAD, false);
    randomData = RandomData.getInstance(RandomData.ALG_SECURE_RANDOM);
    
    // Master Key storage (encrypted by PIN Key)
    encryptedMasterKey = new byte[16];
}
```

---

### 2.4 Code: PBKDF2-HMAC-SHA1 Implementation

```java
/**
 * Derive PIN Key from PIN using PBKDF2-HMAC-SHA1
 * Uses cardId as salt for uniqueness per card
 */
private void derivePinKey(byte[] pinData, short pinOffset, short pinLen,
                          byte[] output, short outOffset) {
    pbkdf2(pinData, pinOffset, pinLen,
           cardId, (short) 0, cardIdLength,    // salt = cardId
           PBKDF2_ITERATIONS,                   // 1000 iterations
           output, outOffset, PBKDF2_KEY_LENGTH);
}

/**
 * PBKDF2-HMAC-SHA1 implementation for JavaCard
 */
private void pbkdf2(byte[] password, short passOff, short passLen,
                    byte[] salt, short saltOff, short saltLen,
                    short iterations,
                    byte[] output, short outOff, short dkLen) {

    // First iteration: U1 = HMAC(password, salt || INT(1))
    Util.arrayCopy(salt, saltOff, hmacBuffer, (short) 0, saltLen);
    hmacBuffer[(short)(saltLen)]     = 0x00;
    hmacBuffer[(short)(saltLen + 1)] = 0x00;
    hmacBuffer[(short)(saltLen + 2)] = 0x00;
    hmacBuffer[(short)(saltLen + 3)] = 0x01;  // Block index = 1

    // U1 = HMAC-SHA1(password, salt || 0x00000001)
    hmacSha1(password, passOff, passLen,
             hmacBuffer, (short) 0, (short)(saltLen + 4),
             pbkdf2Buffer, (short) 0);

    // Copy U1 to output
    Util.arrayCopy(pbkdf2Buffer, (short) 0, output, outOff, dkLen);

    // Subsequent iterations: Ui = HMAC(password, U(i-1)), output ^= Ui
    for (short i = 1; i < iterations; i++) {
        hmacSha1(password, passOff, passLen,
                 pbkdf2Buffer, (short) 0, SHA1_HASH_SIZE,
                 pbkdf2Buffer, (short) 0);

        // XOR with output
        for (short j = 0; j < dkLen; j++) {
            output[(short)(outOff + j)] ^= pbkdf2Buffer[j];
        }
    }
}
```

---

### 2.5 Code: HMAC-SHA1 Implementation

```java
/**
 * HMAC-SHA1 implementation
 * HMAC(K, m) = H((K' XOR opad) || H((K' XOR ipad) || m))
 */
private void hmacSha1(byte[] key, short keyOff, short keyLen,
                      byte[] message, short msgOff, short msgLen,
                      byte[] output, short outOff) {

    // Step 1: Prepare K' (key padded to block size)
    if (keyLen > SHA1_BLOCK_SIZE) {
        sha1.reset();
        sha1.doFinal(key, keyOff, keyLen, hmacKey, (short) 0);
        Util.arrayFillNonAtomic(hmacKey, SHA1_HASH_SIZE,
                (short)(SHA1_BLOCK_SIZE - SHA1_HASH_SIZE), (byte) 0x00);
    } else {
        Util.arrayCopy(key, keyOff, hmacKey, (short) 0, keyLen);
        Util.arrayFillNonAtomic(hmacKey, keyLen,
                (short)(SHA1_BLOCK_SIZE - keyLen), (byte) 0x00);
    }

    // Step 2: Inner hash: H((K' XOR ipad) || message)
    sha1.reset();
    for (short i = 0; i < SHA1_BLOCK_SIZE; i++) {
        hmacBuffer[i] = (byte)(hmacKey[i] ^ 0x36);  // ipad = 0x36
    }
    sha1.update(hmacBuffer, (short) 0, SHA1_BLOCK_SIZE);
    sha1.doFinal(message, msgOff, msgLen, hmacBuffer, (short) 0);

    // Step 3: Outer hash: H((K' XOR opad) || inner_hash)
    sha1.reset();
    for (short i = 0; i < SHA1_BLOCK_SIZE; i++) {
        hmacBuffer[(short)(SHA1_HASH_SIZE + i)] = (byte)(hmacKey[i] ^ 0x5C); // opad
    }
    sha1.update(hmacBuffer, SHA1_HASH_SIZE, SHA1_BLOCK_SIZE);
    sha1.doFinal(hmacBuffer, (short) 0, SHA1_HASH_SIZE, output, outOff);
}
```

---

### 2.6 Code: Khá»Ÿi Táº¡o Tháº»

```java
private void initializeCard(APDU apdu) {
    byte[] buffer = apdu.getBuffer();
    short lc = apdu.setIncomingAndReceive();

    // FORMAT v3.0: [PIN:4][cardIdLength:1][cardId:N]
    short idLen = (short)(buffer[(short)(ISO7816.OFFSET_CDATA + PIN_LENGTH)] & 0xFF);
    
    // Copy Card ID (dÃ¹ng lÃ m salt cho PBKDF2)
    Util.arrayCopy(buffer, (short)(ISO7816.OFFSET_CDATA + PIN_LENGTH + 1), 
                   cardId, (short) 0, idLen);
    cardIdLength = idLen;

    // === PBKDF2 ON APPLET: Derive PIN Key from PIN ===
    derivePinKey(buffer, ISO7816.OFFSET_CDATA, PIN_LENGTH, pin, (short) 0);
    pinKey.setKey(pin, (short) 0);

    // === Generate random Master Key ===
    randomData.generateData(tempBuffer, (short) 0, (short) 16);
    masterKey.setKey(tempBuffer, (short) 0);

    // Encrypt Master Key with PIN Key and store
    aesCipher.init(pinKey, Cipher.MODE_ENCRYPT);
    aesCipher.doFinal(tempBuffer, (short) 0, (short) 16, encryptedMasterKey, (short) 0);

    // Clear temp buffer for security
    Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);

    // Initialize balance to 0 (encrypted with Master Key)
    Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);
    aesCipher.init(masterKey, Cipher.MODE_ENCRYPT);
    aesCipher.doFinal(tempBuffer, (short) 0, (short) 16, encryptedBalance, (short) 0);

    cardInitialized = true;
    pinVerified = true;
    cardActive = true;
}
```

---

### 2.7 Code: XÃ¡c Thá»±c PIN

```java
private void verifyPin(APDU apdu) {
    if (!cardInitialized) ISOException.throwIt(ISO7816.SW_CONDITIONS_NOT_SATISFIED);
    if (!cardActive) ISOException.throwIt(ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED);
    if (pinTryCounter == 0) ISOException.throwIt(ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED);

    byte[] buffer = apdu.getBuffer();
    short lc = apdu.setIncomingAndReceive();

    // Derive PIN Key from received PIN using PBKDF2
    derivePinKey(buffer, ISO7816.OFFSET_CDATA, PIN_LENGTH, tempBuffer, (short) 0);

    // Compare derived PIN Key with stored PIN Key
    if (Util.arrayCompare(pin, (short) 0, tempBuffer, (short) 0, (short) 16) == 0) {
        pinVerified = true;
        pinTryCounter = MAX_PIN_TRIES;

        // Set PIN Key
        pinKey.setKey(tempBuffer, (short) 0);

        // === Decrypt Master Key using PIN Key ===
        aesCipher.init(pinKey, Cipher.MODE_DECRYPT);
        aesCipher.doFinal(encryptedMasterKey, (short) 0, (short) 16, tempBuffer, (short) 0);
        masterKey.setKey(tempBuffer, (short) 0);

        // Clear temp buffer for security
        Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);

        buffer[0] = (byte) 0x01; // Success
        buffer[1] = pinTryCounter;
    } else {
        Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);
        pinTryCounter--;
        pinVerified = false;
        buffer[0] = (byte) 0x00; // Failure
        buffer[1] = pinTryCounter;
    }
    apdu.setOutgoingAndSend((short) 0, (short) 2);
}
```

---

### 2.8 Code: Äá»•i PIN (Nhanh - Chá»‰ Re-encrypt Master Key)

```java
private void updatePin(APDU apdu) {
    if (!cardInitialized || !pinVerified) {
        ISOException.throwIt(ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED);
    }

    byte[] buffer = apdu.getBuffer();
    short lc = apdu.setIncomingAndReceive();

    // FORMAT v3.0: [OLD_PIN:4][NEW_PIN:4]
    // Verify old PIN Key
    derivePinKey(buffer, ISO7816.OFFSET_CDATA, PIN_LENGTH, tempBuffer, (short) 0);
    if (Util.arrayCompare(pin, (short) 0, tempBuffer, (short) 0, (short) 16) != 0) {
        Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);
        ISOException.throwIt(ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED);
    }

    // === Only re-encrypt Master Key, NOT all data! ===

    // 1. Decrypt Master Key with OLD PIN Key
    aesCipher.init(pinKey, Cipher.MODE_DECRYPT);
    aesCipher.doFinal(encryptedMasterKey, (short) 0, (short) 16, tempBalance, (short) 0);

    // 2. Derive new PIN Key from new PIN
    derivePinKey(buffer, (short)(ISO7816.OFFSET_CDATA + PIN_LENGTH), PIN_LENGTH, 
                 pin, (short) 0);

    // 3. Set new PIN Key
    pinKey.setKey(pin, (short) 0);

    // 4. Re-encrypt Master Key with NEW PIN Key
    aesCipher.init(pinKey, Cipher.MODE_ENCRYPT);
    aesCipher.doFinal(tempBalance, (short) 0, (short) 16, encryptedMasterKey, (short) 0);

    // 5. Clear temp buffers for security
    Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);
    Util.arrayFillNonAtomic(tempBalance, (short) 0, (short) 16, (byte) 0x00);

    // === NO need to re-encrypt Balance, Info, Avatar! ===
    // They are encrypted with Master Key, which remains the same!

    buffer[0] = (byte) 0x01;
    apdu.setOutgoingAndSend((short) 0, (short) 1);
}
```

---

### 2.9 Sequence Diagram: Full Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Desktop â”‚         â”‚ CardService â”‚         â”‚   citizen_applet      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚                            â”‚
     â”‚  1. Login request   â”‚                            â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
     â”‚                     â”‚  2. SELECT AID             â”‚
     â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                     â”‚                            â”‚
     â”‚                     â”‚  3. Return: 9000 OK        â”‚
     â”‚                     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                     â”‚                            â”‚
     â”‚                     â”‚  4. VERIFY_PIN (00 00 04 00â”‚[PIN:4])
     â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                     â”‚                            â”‚
     â”‚                     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â”‚           â”‚ 5. PBKDF2(PIN, cardId)          â”‚
     â”‚                     â”‚           â”‚    â†’ tempPinKey                  â”‚
     â”‚                     â”‚           â”‚                                  â”‚
     â”‚                     â”‚           â”‚ 6. Compare tempPinKey == pin[]? â”‚
     â”‚                     â”‚           â”‚    YES â†’ Continue                â”‚
     â”‚                     â”‚           â”‚                                  â”‚
     â”‚                     â”‚           â”‚ 7. AES_Decrypt(encryptedMK,      â”‚
     â”‚                     â”‚           â”‚               tempPinKey)        â”‚
     â”‚                     â”‚           â”‚    â†’ Master Key (loaded)         â”‚
     â”‚                     â”‚           â”‚                                  â”‚
     â”‚                     â”‚           â”‚ 8. pinVerified = true            â”‚
     â”‚                     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚                            â”‚
     â”‚                     â”‚  9. Return: [01][05] + 9000â”‚
     â”‚                     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                     â”‚                            â”‚
     â”‚  10. Login success  â”‚                            â”‚
     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚                     â”‚                            â”‚
```

---

### 2.10 Báº£ng TÃ³m Táº¯t Thuáº­t ToÃ¡n

| ThÃ nh pháº§n | Thuáº­t toÃ¡n | Tham sá»‘ | Má»¥c Ä‘Ã­ch |
|------------|-----------|---------|----------|
| PIN Key Derivation | PBKDF2-HMAC-SHA1 | 1000 iterations, salt=cardId | Chá»‘ng brute-force, unique per card |
| Master Key | Secure Random | 128-bit | MÃ£ hÃ³a dá»¯ liá»‡u thá»±c táº¿ |
| Data Encryption | AES-128 ECB | No padding | MÃ£ hÃ³a Balance, Info, Avatar |
| Master Key Wrap | AES-128 ECB | PIN Key | Báº£o vá»‡ Master Key |
| Digital Signature | RSA-1024 PKCS1 | SHA-1 | XÃ¡c thá»±c tháº» |
| PIN Storage | PBKDF2 output | 16 bytes | So sÃ¡nh khi verify |

---

### 2.11 Security Best Practices Trong Code

```java
// 1. LuÃ´n clear buffer sau khi sá»­ dá»¥ng
Util.arrayFillNonAtomic(tempBuffer, (short) 0, (short) 16, (byte) 0x00);

// 2. Kiá»ƒm tra tráº¡ng thÃ¡i trÆ°á»›c má»i thao tÃ¡c nháº¡y cáº£m
if (!cardInitialized || !pinVerified) {
    ISOException.throwIt(ISO7816.SW_SECURITY_STATUS_NOT_SATISFIED);
}

// 3. Giáº£m counter trÆ°á»›c khi thÃ´ng bÃ¡o lá»—i (avoid timing attack)
pinTryCounter--;
pinVerified = false;

// 4. Sá»­ dá»¥ng constant-time comparison cho PIN
Util.arrayCompare(pin, (short) 0, tempBuffer, (short) 0, (short) 16);

// 5. Master Key khÃ´ng bao giá» lÆ°u plaintext lÃ¢u dÃ i
// Chá»‰ load vÃ o RAM khi cáº§n, clear sau khi dÃ¹ng
```

---

## Káº¿t Luáº­n

Citizen Card Applet v3.0 cung cáº¥p má»™t kiáº¿n trÃºc báº£o máº­t máº¡nh máº½ vá»›i:

1. **PBKDF2 on-card** - PIN Ä‘Æ°á»£c xá»­ lÃ½ hoÃ n toÃ n trÃªn tháº», khÃ´ng bao giá» rá»i khá»i secure element
2. **Two-layer key architecture** - TÃ¡ch biá»‡t PIN Key vÃ  Master Key cho hiá»‡u suáº¥t vÃ  báº£o máº­t
3. **Fast PIN change** - Äá»•i PIN chá»‰ máº¥t ~10ms thay vÃ¬ hÃ ng giÃ¢y
4. **Brute-force protection** - 1000 PBKDF2 iterations + 5 láº§n thá»­ tá»‘i Ä‘a
5. **Unique keys per card** - Salt = cardId Ä‘áº£m báº£o má»—i tháº» cÃ³ PIN Key khÃ¡c nhau

---

*TÃ i liá»‡u cáº­p nháº­t: ThÃ¡ng 1/2026*
*Version: 3.0*
